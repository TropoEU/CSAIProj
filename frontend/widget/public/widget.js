var CSAIWidget=function(t){"use strict";class e{constructor(t,e){this.apiKey=t,this.baseUrl=e.replace(/\/$/,"")}async sendMessage(t,e){try{const s=await fetch(`${this.baseUrl}/chat/message`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({sessionId:t,message:e})});if(!s.ok){const t=await s.json().catch(()=>({}));throw new Error(t.error||`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(s){throw console.error("ChatAPI: Failed to send message",s),s}}async getHistory(t){try{const e=await fetch(`${this.baseUrl}/chat/history/${t}`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t.error||`HTTP ${e.status}: ${e.statusText}`)}return(await e.json()).messages||[]}catch(e){throw console.error("ChatAPI: Failed to get history",e),e}}async endSession(t){try{const e=await fetch(`${this.baseUrl}/chat/end`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({sessionId:t})});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t.error||`HTTP ${e.status}: ${e.statusText}`)}return await e.json()}catch(e){throw console.error("ChatAPI: Failed to end session",e),e}}}class s{constructor(t="csai_widget"){this.prefix=t,this.isAvailable=this.checkAvailability()}checkAvailability(){try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return console.warn("WidgetStorage: localStorage is not available",t),!1}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}getSessionId(){let t=this.get("sessionId");return t||(t=this.generateSessionId(),this.set("sessionId",t)),t}get(t){if(!this.isAvailable)return null;try{const e=`${this.prefix}_${t}`,s=localStorage.getItem(e);return s?JSON.parse(s):null}catch(e){return console.error(`WidgetStorage: Failed to get ${t}`,e),null}}set(t,e){if(this.isAvailable)try{const s=`${this.prefix}_${t}`;localStorage.setItem(s,JSON.stringify(e))}catch(s){console.error(`WidgetStorage: Failed to set ${t}`,s)}}remove(t){if(this.isAvailable)try{const e=`${this.prefix}_${t}`;localStorage.removeItem(e)}catch(e){console.error(`WidgetStorage: Failed to remove ${t}`,e)}}saveMessages(t){const e=t.slice(-20);this.set("messages",e)}getMessages(){return this.get("messages")||[]}setWidgetState(t){this.set("widgetOpen",t)}getWidgetState(){return this.get("widgetOpen")||!1}setUnreadCount(t){this.set("unreadCount",t)}getUnreadCount(){return this.get("unreadCount")||0}clearAll(){if(!this.isAvailable)return;["sessionId","messages","widgetOpen","unreadCount"].forEach(t=>this.remove(t))}}class i{constructor(t,e={}){this.onClick=t,this.config=e,this.element=this.create(),this.unreadCount=0,this.applyColors()}create(){const t=document.createElement("button");return t.className="csai-chat-bubble",t.setAttribute("aria-label","Open chat"),t.innerHTML='\n      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>\n      </svg>\n    ',t.addEventListener("click",()=>{this.onClick(),this.toggleOpen()}),t}applyColors(){if(this.config.headerBgColor&&(this.element.style.backgroundColor=this.config.headerBgColor),this.config.headerTextColor){const t=this.element.querySelector("svg");t&&(t.style.fill=this.config.headerTextColor)}}toggleOpen(){this.element.classList.toggle("open")}setUnreadCount(t){this.unreadCount=t;const e=this.element.querySelector(".csai-unread-badge");if(e&&e.remove(),t>0){const e=document.createElement("span");e.className="csai-unread-badge",e.textContent=t>99?"99+":t,this.element.appendChild(e)}}getElement(){return this.element}}class o{constructor(){this.element=this.create(),this.messages=[]}create(){const t=document.createElement("div");return t.className="csai-messages",t}addMessage(t){this.messages.push(t);const e=this.createMessageElement(t);this.element.appendChild(e),this.scrollToBottom()}createMessageElement(t){const e=document.createElement("div");e.className="csai-message "+("user"===t.role?"user":"ai");const s=document.createElement("div");s.className="csai-message-bubble",s.textContent=t.content;const i=document.createElement("div");return i.className="csai-message-time",i.textContent=this.formatTime(t.timestamp),e.appendChild(s),e.appendChild(i),e}formatTime(t){const e=t instanceof Date?t:new Date(t);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}showTyping(){this.hideTyping();const t=document.createElement("div");t.className="csai-message ai",t.setAttribute("data-typing","true");const e=document.createElement("div");e.className="csai-typing-indicator",e.innerHTML='\n      <div class="csai-typing-dot"></div>\n      <div class="csai-typing-dot"></div>\n      <div class="csai-typing-dot"></div>\n    ',t.appendChild(e),this.element.appendChild(t),this.scrollToBottom()}hideTyping(){const t=this.element.querySelector('[data-typing="true"]');t&&t.remove()}showError(t,e){const s=document.createElement("div");if(s.className="csai-error-message",s.innerHTML=`\n      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n      </svg>\n      <div>\n        <div>${t}</div>\n        ${e?'<button class="csai-retry-button">Retry</button>':""}\n      </div>\n    `,e){s.querySelector(".csai-retry-button").addEventListener("click",()=>{s.remove(),e()})}this.element.appendChild(s),this.scrollToBottom()}loadMessages(t){this.clear();const e=t.filter(t=>"user"===t.role||"assistant"===t.role);this.messages=e,e.forEach(t=>{const e=this.createMessageElement(t);this.element.appendChild(e)}),this.scrollToBottom()}clear(){this.element.innerHTML="",this.messages=[]}showEmptyState(t){this.clear();const e=document.createElement("div");e.className="csai-empty-state",e.innerHTML=`\n      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>\n      </svg>\n      <div class="csai-empty-title">Start a conversation</div>\n      <div class="csai-empty-subtitle">${t}</div>\n    `,this.element.appendChild(e)}scrollToBottom(){setTimeout(()=>{this.element.scrollTop=this.element.scrollHeight},0)}getElement(){return this.element}getMessages(){return this.messages}}class a{constructor(t,e={}){this.onSend=t,this.config=e,this.element=this.create(),this.input=this.element.querySelector(".csai-input"),this.sendButton=this.element.querySelector(".csai-send-button"),this.applyColors()}create(){const t=document.createElement("div");t.className="csai-input-area",t.innerHTML='\n      <textarea\n        class="csai-input"\n        placeholder="Type your message..."\n        rows="1"\n        aria-label="Message input"\n      ></textarea>\n      <button class="csai-send-button" aria-label="Send message">\n        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n        </svg>\n      </button>\n    ';const e=t.querySelector(".csai-input"),s=t.querySelector(".csai-send-button");return e.addEventListener("input",()=>{this.autoResize(),this.updateSendButton()}),e.addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.handleSend())}),s.addEventListener("click",()=>{this.handleSend()}),t}applyColors(){if(this.config.footerBgColor&&(this.element.style.backgroundColor=this.config.footerBgColor),this.config.inputBgColor&&(this.input.style.backgroundColor=this.config.inputBgColor),this.config.inputTextColor&&(this.input.style.color=this.config.inputTextColor),this.config.buttonTextColor){const t=this.sendButton.querySelector("svg");t&&(t.style.fill=this.config.buttonTextColor,t.style.width="18px",t.style.height="18px")}}autoResize(){this.input.style.height="auto",this.input.style.height=Math.min(this.input.scrollHeight,100)+"px"}updateSendButton(){const t=this.input.value.trim().length>0;this.sendButton.disabled=!t}handleSend(){const t=this.input.value.trim();t&&!this.sendButton.disabled&&(this.onSend(t),this.clear())}clear(){this.input.value="",this.input.style.height="auto",this.updateSendButton(),this.input.focus()}setValue(t){this.input.value=t,this.autoResize(),this.updateSendButton()}focus(){this.input.focus()}disable(){this.input.disabled=!0,this.sendButton.disabled=!0}enable(){this.input.disabled=!1,this.updateSendButton()}getElement(){return this.element}}class n{constructor(t,e,s){this.config=t,this.onClose=e,this.onSend=s,this.element=this.create(),this.messageList=new o,this.inputArea=new a(t=>this.handleSend(t),t),this.isOpen=!1}create(){const t=document.createElement("div");t.className="csai-chat-window csai-hidden";const e=this.createHeader();return t.appendChild(e),t}createHeader(){const t=document.createElement("div");t.className="csai-window-header";const e=this.config.title||"Chat Support",s=this.config.subtitle||"We typically reply instantly";if(this.config.headerTextColor&&(t.style.color=this.config.headerTextColor),t.innerHTML=`\n      <div>\n        <div class="csai-header-title">${e}</div>\n        <div class="csai-header-subtitle">${s}</div>\n      </div>\n      <div class="csai-header-actions">\n        <button class="csai-header-button csai-close-button" aria-label="Close">\n          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n          </svg>\n        </button>\n      </div>\n    `,this.config.headerBgColor&&(t.style.backgroundColor=this.config.headerBgColor),this.config.buttonTextColor){const e=t.querySelector(".csai-close-button svg");e&&(e.style.fill=this.config.buttonTextColor)}return t.querySelector(".csai-close-button").addEventListener("click",()=>{this.close(),this.onClose&&this.onClose()}),t}init(){if(this.element.appendChild(this.messageList.getElement()),this.element.appendChild(this.inputArea.getElement()),0===this.messageList.getMessages().length){const t=this.config.greeting||"Hi! How can I help you today?";this.messageList.showEmptyState(t)}}handleSend(t){this.onSend&&this.onSend(t)}open(){this.element.classList.remove("csai-hidden"),this.isOpen=!0,this.inputArea.focus()}close(){this.element.classList.add("csai-hidden"),this.isOpen=!1}toggle(){this.isOpen?this.close():this.open()}addMessage(t){const e=this.element.querySelector(".csai-empty-state");e&&e.remove(),this.messageList.addMessage(t)}loadMessages(t){if(t&&t.length>0)this.messageList.loadMessages(t);else{const t=this.config.greeting||"Hi! How can I help you today?";this.messageList.showEmptyState(t)}}showTyping(){this.messageList.showTyping()}hideTyping(){this.messageList.hideTyping()}showError(t,e){this.messageList.showError(t,e)}disableInput(){this.inputArea.disable()}enableInput(){this.inputArea.enable()}getElement(){return this.element}getMessages(){return this.messageList.getMessages()}}class r{constructor(t){this.config=this.parseConfig(t),this.api=new e(this.config.apiKey,this.config.apiUrl),this.storage=new s,this.sessionId=this.storage.getSessionId(),this.container=null,this.shadowRoot=null,this.bubble=null,this.window=null,this.pendingMessage=null,this.init()}parseConfig(t){if(!t.apiKey)throw new Error("ChatWidget: apiKey is required");return{apiKey:t.apiKey,apiUrl:"http://localhost:3000",position:t.position||"bottom-right",primaryColor:t.primaryColor||"#667eea",backgroundColor:t.backgroundColor||"#ffffff",headerBgColor:t.headerBgColor||t.primaryColor||"#667eea",bodyBgColor:t.bodyBgColor||t.backgroundColor||"#ffffff",footerBgColor:t.footerBgColor||t.backgroundColor||"#ffffff",aiBubbleColor:t.aiBubbleColor||"#f3f4f6",userBubbleColor:t.userBubbleColor||"#667eea",headerTextColor:t.headerTextColor||"#111827",aiTextColor:t.aiTextColor||"#111827",userTextColor:t.userTextColor||"#ffffff",inputBgColor:t.inputBgColor||"#f9fafb",inputTextColor:t.inputTextColor||"#111827",buttonTextColor:t.buttonTextColor||"#ffffff",greeting:t.greeting||"Hi! How can I help you today?",title:t.title||"Chat Support",subtitle:t.subtitle||"We typically reply instantly",...t}}init(){this.createContainer(),this.createShadowDOM(),this.injectStyles(),this.createComponents(),this.loadHistory(),this.attachToDOM(),console.log("ChatWidget: Initialized",{sessionId:this.sessionId,config:this.config})}createContainer(){this.container=document.createElement("div"),this.container.className=`csai-widget-container position-${this.config.position}`,this.container.style.position="fixed",this.container.style.zIndex="999999";const t=this.config.position||"bottom-right";t.includes("bottom")?(this.container.style.bottom="20px",this.container.style.top="auto"):(this.container.style.top="20px",this.container.style.bottom="auto"),t.includes("right")?(this.container.style.right="20px",this.container.style.left="auto"):(this.container.style.left="20px",this.container.style.right="auto")}createShadowDOM(){this.shadowRoot=this.container.attachShadow({mode:"open"})}injectStyles(){const t=document.createElement("style");t.textContent=":host{--primary-color: #0066cc;--primary-hover: #0052a3;--background: #ffffff;--text-color: #333333;--text-light: #666666;--border-color: #e0e0e0;--user-message-bg: #0066cc;--user-message-text: #ffffff;--ai-message-bg: #f5f5f5;--ai-message-text: #333333;--error-color: #dc3545;--shadow: 0 4px 12px rgba(0, 0, 0, .15);--shadow-lg: 0 8px 24px rgba(0, 0, 0, .2);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:14px;line-height:1.5;color:var(--text-color)}*{box-sizing:border-box;margin:0;padding:0}.csai-widget-container{position:fixed;z-index:999999;font-family:inherit}.csai-widget-container.position-bottom-right{bottom:20px;right:20px}.csai-widget-container.position-bottom-left{bottom:20px;left:20px}.csai-widget-container.position-top-right{top:20px;right:20px}.csai-widget-container.position-top-left{top:20px;left:20px}.csai-chat-bubble{width:60px;height:60px;border-radius:50%;background:var(--header-bg, var(--primary-color));border:none;box-shadow:var(--shadow);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease;position:fixed;z-index:999999;animation:fadeIn .5s ease}:host(.position-bottom-right) .csai-chat-bubble{bottom:20px;right:20px}:host(.position-bottom-left) .csai-chat-bubble{bottom:20px;left:20px}:host(.position-top-right) .csai-chat-bubble{top:20px;right:20px}:host(.position-top-left) .csai-chat-bubble{top:20px;left:20px}.csai-chat-bubble:hover{background:var(--primary-hover);transform:scale(1.05);box-shadow:var(--shadow-lg)}.csai-chat-bubble svg{width:28px;height:28px}.csai-chat-bubble.open{transform:scale(.95)}.csai-unread-badge{position:absolute;top:-5px;right:-5px;background:#dc3545;color:#fff;border-radius:12px;padding:2px 6px;font-size:11px;font-weight:700;min-width:18px;text-align:center;box-shadow:0 2px 4px #0003;animation:bounceIn .5s ease}.csai-chat-window{position:fixed;width:400px;max-width:calc(100vw - 40px);max-height:calc(100vh - 40px);height:600px;background:var(--background);border-radius:12px;box-shadow:var(--shadow-lg);display:flex;flex-direction:column;overflow:hidden;animation:slideUp .3s ease;z-index:999999}:host(.position-bottom-right) .csai-chat-window{bottom:20px;right:20px}:host(.position-bottom-left) .csai-chat-window{bottom:20px;left:20px}:host(.position-top-right) .csai-chat-window{top:20px;right:20px}:host(.position-top-left) .csai-chat-window{top:20px;left:20px}.csai-window-header{background:var(--header-bg, var(--primary-color));color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.csai-header-title{font-size:16px;font-weight:600}.csai-header-subtitle{font-size:12px;opacity:.9;margin-top:2px}.csai-header-actions{display:flex;gap:8px}.csai-header-button{background:#fff3;border:none;color:#fff;width:32px;height:32px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}.csai-header-button:hover{background:#ffffff4d}.csai-header-button svg{width:18px;height:18px}.csai-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}.csai-messages::-webkit-scrollbar{width:6px}.csai-messages::-webkit-scrollbar-track{background:transparent}.csai-messages::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}.csai-messages::-webkit-scrollbar-thumb:hover{background:silver}.csai-message{display:flex;flex-direction:column;max-width:80%;animation:fadeInUp .3s ease}.csai-message.user{align-self:flex-end;align-items:flex-end}.csai-message.ai{align-self:flex-start;align-items:flex-start}.csai-message-bubble{padding:10px 14px;border-radius:12px;word-wrap:break-word;white-space:pre-wrap}.csai-message.user .csai-message-bubble{background:var(--user-message-bg);color:var(--user-message-text);border-bottom-right-radius:4px}.csai-message.ai .csai-message-bubble{background:var(--ai-message-bg);color:var(--ai-message-text);border-bottom-left-radius:4px}.csai-message-time{font-size:11px;color:var(--text-light);margin-top:4px;padding:0 4px}.csai-typing-indicator{display:flex;gap:4px;padding:12px 14px;background:var(--ai-message-bg);border-radius:12px 12px 12px 4px;width:fit-content}.csai-typing-dot{width:8px;height:8px;border-radius:50%;background:var(--text-light);animation:typing 1.4s infinite}.csai-typing-dot:nth-child(2){animation-delay:.2s}.csai-typing-dot:nth-child(3){animation-delay:.4s}.csai-error-message{background:#fff3f3;border:1px solid #ffcdd2;color:var(--error-color);padding:12px;border-radius:8px;font-size:13px;display:flex;align-items:flex-start;gap:8px}.csai-error-message svg{width:16px;height:16px;fill:var(--error-color);flex-shrink:0;margin-top:1px}.csai-retry-button{background:var(--error-color);color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:12px;cursor:pointer;margin-top:8px;transition:opacity .2s}.csai-retry-button:hover{opacity:.9}.csai-input-area{padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px;flex-shrink:0;background:var(--footer-bg, var(--background))}.csai-input{flex:1;border:1px solid var(--border-color);border-radius:20px;padding:10px 16px;font-size:14px;font-family:inherit;outline:none;resize:none;max-height:100px;min-height:40px;transition:border-color .2s}.csai-input:focus{border-color:var(--primary-color)}.csai-send-button{width:40px;height:40px;border-radius:50%;background:var(--primary-color);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}.csai-send-button:hover:not(:disabled){background:var(--primary-hover);transform:scale(1.05)}.csai-send-button:disabled{opacity:.5;cursor:not-allowed}.csai-send-button svg{width:18px;height:18px;fill:#fff}.csai-empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--text-light)}.csai-empty-state svg{width:64px;height:64px;fill:var(--border-color);margin-bottom:16px}.csai-empty-title{font-size:18px;font-weight:600;color:var(--text-color);margin-bottom:8px}.csai-empty-subtitle{font-size:14px}@keyframes fadeIn{0%{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}@keyframes slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeInUp{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.2)}to{transform:scale(1)}}@keyframes typing{0%,60%,to{transform:translateY(0);opacity:.7}30%{transform:translateY(-10px);opacity:1}}@media (max-width: 480px){.csai-chat-window{position:fixed;bottom:0;left:0;right:0;top:0;width:100%;height:100%;border-radius:0;animation:slideUp .3s ease}.csai-widget-container.position-bottom-left .csai-chat-window,.csai-widget-container.position-top-left .csai-chat-window,.csai-widget-container.position-top-right .csai-chat-window{left:0;right:0;top:0;bottom:0}.csai-message{max-width:85%}}.csai-hidden{display:none!important}",t.textContent+=`\n      :host {\n        --primary-color: ${this.config.primaryColor};\n        --primary-hover: ${this.adjustColor(this.config.primaryColor,-20)};\n        --background: ${this.config.bodyBgColor};\n        --header-bg: ${this.config.headerBgColor};\n        --footer-bg: ${this.config.footerBgColor};\n        --user-message-bg: ${this.config.userBubbleColor};\n        --user-message-text: ${this.config.userTextColor};\n        --ai-message-bg: ${this.config.aiBubbleColor};\n        --ai-message-text: ${this.config.aiTextColor};\n      }\n    `,this.shadowRoot.appendChild(t)}adjustColor(t,e){const s=t=>Math.min(Math.max(t,0),255),i=parseInt(t.replace("#",""),16);return`#${(s((i>>16)+e)<<16|s((i>>8&255)+e)<<8|s((255&i)+e)).toString(16).padStart(6,"0")}`}createComponents(){this.bubble=new i(()=>this.toggleWindow(),this.config),this.window=new n(this.config,()=>this.handleClose(),t=>this.handleSend(t)),this.shadowRoot.appendChild(this.bubble.getElement()),this.shadowRoot.appendChild(this.window.getElement()),this.window.init(),this.updateBubbleVisibility()}async loadHistory(){try{const t=this.storage.getMessages();if(t&&t.length>0){const e=t.filter(t=>"user"===t.role||"assistant"===t.role);if(e.length>0)return void this.window.loadMessages(e)}const e=await this.api.getHistory(this.sessionId);if(e&&e.length>0){const t=e.filter(t=>"user"===t.role||"assistant"===t.role).map(t=>({role:t.role,content:t.content,timestamp:new Date(t.created_at)}));this.window.loadMessages(t),this.storage.saveMessages(t)}else this.window.loadMessages([])}catch(t){console.error("ChatWidget: Failed to load history",t),this.window.loadMessages([])}}attachToDOM(){document.body.appendChild(this.container);this.storage.getWidgetState()&&this.window.open(),this.updateBubbleVisibility()}toggleWindow(){this.window.toggle(),this.storage.setWidgetState(this.window.isOpen),this.updateBubbleVisibility(),this.window.isOpen&&(this.bubble.setUnreadCount(0),this.storage.setUnreadCount(0))}updateBubbleVisibility(){this.bubble&&this.window&&(this.window.isOpen?this.bubble.getElement().style.display="none":this.bubble.getElement().style.display="flex")}handleClose(){this.storage.setWidgetState(!1),this.updateBubbleVisibility()}async handleSend(t){const e={role:"user",content:t,timestamp:new Date};this.window.addMessage(e);const s=this.window.getMessages();this.storage.saveMessages(s),this.window.disableInput(),this.window.showTyping(),this.pendingMessage=t;try{const e=await this.api.sendMessage(this.sessionId,t);this.window.hideTyping();const s={role:"assistant",content:e.response,timestamp:new Date};this.window.addMessage(s);const i=this.window.getMessages();if(this.storage.saveMessages(i),!this.window.isOpen){const t=this.storage.getUnreadCount()+1;this.bubble.setUnreadCount(t),this.storage.setUnreadCount(t)}this.pendingMessage=null}catch(i){console.error("ChatWidget: Failed to send message",i),this.window.hideTyping(),this.window.showError("Failed to send message. Please try again.",()=>this.retryLastMessage())}finally{this.window.enableInput()}}retryLastMessage(){this.pendingMessage&&this.handleSend(this.pendingMessage)}open(){this.window.isOpen||this.toggleWindow()}close(){this.window.isOpen&&this.toggleWindow()}clearHistory(){this.storage.clearAll(),this.sessionId=this.storage.getSessionId(),this.window.loadMessages([])}destroy(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}function l(){const t=function(){const t=document.querySelectorAll("script[data-api-key]"),e=t[t.length-1];if(!e)return console.error("ChatWidget: No script tag found with data-api-key attribute"),null;const s={apiKey:e.getAttribute("data-api-key"),position:e.getAttribute("data-position"),primaryColor:e.getAttribute("data-primary-color"),backgroundColor:e.getAttribute("data-background-color"),headerBgColor:e.getAttribute("data-header-bg-color"),bodyBgColor:e.getAttribute("data-body-bg-color"),footerBgColor:e.getAttribute("data-footer-bg-color"),aiBubbleColor:e.getAttribute("data-ai-bubble-color"),userBubbleColor:e.getAttribute("data-user-bubble-color"),headerTextColor:e.getAttribute("data-header-text-color"),aiTextColor:e.getAttribute("data-ai-text-color"),userTextColor:e.getAttribute("data-user-text-color"),inputBgColor:e.getAttribute("data-input-bg-color"),inputTextColor:e.getAttribute("data-input-text-color"),buttonTextColor:e.getAttribute("data-button-text-color"),greeting:e.getAttribute("data-greeting"),title:e.getAttribute("data-title"),subtitle:e.getAttribute("data-subtitle")};return Object.keys(s).forEach(t=>{null!==s[t]&&void 0!==s[t]||delete s[t]}),s}();if(t)if(t.apiKey)try{const e=new r(t);window.CSAIWidget=e,console.log("ChatWidget: Successfully initialized")}catch(e){console.error("ChatWidget: Initialization failed",e)}else console.error("ChatWidget: data-api-key attribute is required");else console.error("ChatWidget: Failed to get configuration from script tag")}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",l):l(),t.ChatWidget=r,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),t}({});
//# sourceMappingURL=widget.js.map
