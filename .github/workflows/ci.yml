name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ===================================
  # Security: npm audit
  # ===================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Audit backend dependencies
        working-directory: backend
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit admin dependencies
        working-directory: frontend/admin
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit customer dependencies
        working-directory: frontend/customer
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit widget dependencies
        working-directory: frontend/widget
        run: npm audit --audit-level=high
        continue-on-error: true

  # ===================================
  # Lint: ESLint + Prettier
  # ===================================
  lint:
    name: Lint (${{ matrix.project }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - project: backend
            path: backend
          - project: admin
            path: frontend/admin
          - project: customer
            path: frontend/customer
          - project: widget
            path: frontend/widget

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.path }}
        run: npm ci

      - name: Run ESLint
        working-directory: ${{ matrix.path }}
        run: npm run lint

      - name: Check Prettier formatting
        working-directory: ${{ matrix.path }}
        run: npm run format:check
        continue-on-error: true  # Formatting is a soft requirement

  # ===================================
  # Unit Tests (Backend) with Coverage
  # ===================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Run unit tests with coverage
        working-directory: backend
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage
          retention-days: 7

      - name: Report coverage summary
        working-directory: backend
        run: |
          echo "## ğŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            # Extract coverage percentages from JSON
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')

            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage summary not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'backend/coverage/coverage-summary.json';

            if (!fs.existsSync(path)) {
              console.log('Coverage summary not found');
              return;
            }

            const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
            const total = coverage.total;

            const getEmoji = (pct) => {
              if (pct >= 60) return 'ğŸŸ¢';
              if (pct >= 25) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };

            const body = `## ğŸ“Š Code Coverage Report

            | Metric | Coverage |
            |--------|----------|
            | ${getEmoji(total.lines.pct)} Lines | ${total.lines.pct}% |
            | ${getEmoji(total.statements.pct)} Statements | ${total.statements.pct}% |
            | ${getEmoji(total.functions.pct)} Functions | ${total.functions.pct}% |
            | ${getEmoji(total.branches.pct)} Branches | ${total.branches.pct}% |

            <details>
            <summary>Coverage thresholds</summary>

            - ğŸŸ¢ >= 60%
            - ğŸŸ¡ >= 25%
            - ğŸ”´ < 25%
            </details>`;

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“Š Code Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ===================================
  # Build All Frontend Apps
  # ===================================
  build-frontend:
    name: Build Frontend (${{ matrix.app }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        app: [admin, customer, widget]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/${{ matrix.app }}/package-lock.json

      - name: Install dependencies
        working-directory: frontend/${{ matrix.app }}
        run: npm ci

      - name: Build
        working-directory: frontend/${{ matrix.app }}
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-build
          path: frontend/${{ matrix.app }}/dist
          retention-days: 7

  # ===================================
  # Database & Model Tests
  # ===================================
  test-models:
    name: Database & Model Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: csai
          POSTGRES_PASSWORD: csai_dev_password
          POSTGRES_DB: csai_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << EOF
          POSTGRES_HOST=localhost
          POSTGRES_PORT=5432
          POSTGRES_USER=csai
          POSTGRES_PASSWORD=csai_dev_password
          POSTGRES_DB=csai_dev
          REDIS_HOST=localhost
          REDIS_PORT=6379
          JWT_SECRET=test-jwt-secret-for-ci
          PORT=3000
          NODE_ENV=test
          EOF

      - name: Run database migrations
        run: npm run migrate

      - name: Run all model integration tests
        run: npm run test:all

  # ===================================
  # Redis Cache Service Tests
  # ===================================
  test-redis:
    name: Redis Cache Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << EOF
          REDIS_HOST=localhost
          REDIS_PORT=6379
          NODE_ENV=test
          EOF

      - name: Run Redis cache tests
        run: npm run test:redis

  # ===================================
  # LLM Service Tests (Groq)
  # ===================================
  test-llm:
    name: LLM Service Tests (Groq)
    runs-on: ubuntu-latest
    # Only run on push to main repo (secrets not available for forks)
    if: ${{ github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << EOF
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER=groq
          GROQ_MODEL=llama-3.3-70b-versatile
          NODE_ENV=test
          EOF

      - name: Run LLM service tests
        run: npm run test:llm:ci
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

  # ===================================
  # Billing & Usage Tests (Phase 6)
  # ===================================
  test-billing:
    name: Billing & Usage Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: csai
          POSTGRES_PASSWORD: csai_dev_password
          POSTGRES_DB: csai_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << EOF
          POSTGRES_HOST=localhost
          POSTGRES_PORT=5432
          POSTGRES_USER=csai
          POSTGRES_PASSWORD=csai_dev_password
          POSTGRES_DB=csai_dev
          REDIS_HOST=localhost
          REDIS_PORT=6379
          JWT_SECRET=test-jwt-secret-for-ci
          PORT=3000
          NODE_ENV=test
          EOF

      - name: Run database migrations
        run: npm run migrate

      - name: Generate mock data for billing tests
        run: npm run mockdata

      - name: Run billing & usage tests (Phase 6)
        run: npm run test:phase6

  # ===================================
  # API Health Check
  # ===================================
  test-api-health:
    name: API Health Check
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: csai
          POSTGRES_PASSWORD: csai_dev_password
          POSTGRES_DB: csai_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Create .env file
        working-directory: backend
        run: |
          cat > .env << EOF
          POSTGRES_HOST=localhost
          POSTGRES_PORT=5432
          POSTGRES_USER=csai
          POSTGRES_PASSWORD=csai_dev_password
          POSTGRES_DB=csai_dev
          REDIS_HOST=localhost
          REDIS_PORT=6379
          JWT_SECRET=test-jwt-secret-for-ci
          PORT=3000
          NODE_ENV=test
          EOF

      - name: Run database migrations
        run: npm run migrate

      - name: Start server and test health endpoint
        run: |
          # Start server in background
          node src/index.js &
          SERVER_PID=$!

          # Wait for server to start
          sleep 5

          # Test health endpoint
          echo "Testing /health endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $RESPONSE)"
          else
            echo "âŒ Health check failed (HTTP $RESPONSE)"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi

          # Test API root
          echo "Testing / endpoint..."
          RESPONSE=$(curl -s http://localhost:3000/)
          echo "Response: $RESPONSE"

          # Cleanup
          kill $SERVER_PID 2>/dev/null
          echo "âœ… API health tests passed"
        working-directory: backend

  # ===================================
  # CI Success Gate
  # ===================================
  ci-success:
    name: CI Success
    needs:
      [
        security-audit,
        lint,
        unit-tests,
        build-frontend,
        test-models,
        test-redis,
        test-billing,
        test-api-health,
      ]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check required jobs
        run: |
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Build Frontend: ${{ needs.build-frontend.result }}"
          echo "Test Models: ${{ needs.test-models.result }}"
          echo "Test Redis: ${{ needs.test-redis.result }}"
          echo "Test Billing: ${{ needs.test-billing.result }}"
          echo "Test API Health: ${{ needs.test-api-health.result }}"

          # Required jobs (must pass)
          if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.build-frontend.result }}" != "success" ]] || \
             [[ "${{ needs.test-models.result }}" != "success" ]] || \
             [[ "${{ needs.test-redis.result }}" != "success" ]] || \
             [[ "${{ needs.test-billing.result }}" != "success" ]] || \
             [[ "${{ needs.test-api-health.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "âŒ One or more required jobs failed"
            exit 1
          fi

          # Soft failures (warn but don't fail CI)
          if [[ "${{ needs.security-audit.result }}" != "success" ]]; then
            echo "âš ï¸  Security audit found issues - please review"
          fi

          echo "âœ… All required CI checks passed!"

      - name: Report LLM test status
        if: always()
        run: |
          echo "Note: LLM tests run only on push to main repo (requires secrets)"
