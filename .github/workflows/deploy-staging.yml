name: Deploy to Staging

on:
  # Trigger after CI passes on main branch
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_ci_check:
        description: 'Skip CI check (force deploy)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ===================================
  # Check if we should deploy
  # ===================================
  check-deploy:
    name: Check Deploy Conditions
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Check CI status
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.skip_ci_check }}" == "true" ]]; then
              echo "Manual deploy requested (skip CI check)"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "Manual deploy requested"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "CI passed, proceeding with deploy"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "CI did not pass, skipping deploy"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ===================================
  # Deploy Frontends to Cloudflare Pages
  # Note: Railway backend auto-deploys on push to main
  # ===================================
  deploy-cloudflare:
    name: Deploy Frontends (Cloudflare)
    runs-on: ubuntu-latest
    needs: check-deploy
    if: needs.check-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Trigger Cloudflare Pages Deploys
        run: |
          DEPLOYED=""

          # Admin Dashboard
          if [ -n "$ADMIN_HOOK" ]; then
            echo "Triggering Admin Dashboard deploy..."
            curl -X POST "$ADMIN_HOOK" && DEPLOYED="$DEPLOYED admin"
          else
            echo "Admin hook not configured (Cloudflare auto-deploys from GitHub)"
          fi

          # Customer Dashboard
          if [ -n "$CUSTOMER_HOOK" ]; then
            echo "Triggering Customer Dashboard deploy..."
            curl -X POST "$CUSTOMER_HOOK" && DEPLOYED="$DEPLOYED customer"
          else
            echo "Customer hook not configured (Cloudflare auto-deploys from GitHub)"
          fi

          # Widget
          if [ -n "$WIDGET_HOOK" ]; then
            echo "Triggering Widget deploy..."
            curl -X POST "$WIDGET_HOOK" && DEPLOYED="$DEPLOYED widget"
          else
            echo "Widget hook not configured (Cloudflare auto-deploys from GitHub)"
          fi

          if [ -n "$DEPLOYED" ]; then
            echo "Triggered deploys for:$DEPLOYED"
          else
            echo "No deploy hooks configured - Cloudflare Pages auto-deploys from GitHub"
          fi
        env:
          ADMIN_HOOK: ${{ secrets.CLOUDFLARE_DEPLOY_HOOK_ADMIN }}
          CUSTOMER_HOOK: ${{ secrets.CLOUDFLARE_DEPLOY_HOOK_CUSTOMER }}
          WIDGET_HOOK: ${{ secrets.CLOUDFLARE_DEPLOY_HOOK_WIDGET }}
        continue-on-error: true

  # ===================================
  # Verify Staging Deployment
  # ===================================
  verify-deployment:
    name: Verify Staging
    runs-on: ubuntu-latest
    needs: [deploy-cloudflare]
    if: needs.check-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Wait for deployments to propagate
        run: sleep 30

      - name: Check Backend Health
        run: |
          echo "Checking Railway backend health..."
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
          if [ "$HEALTH" = "200" ]; then
            echo "Backend is healthy (HTTP $HEALTH)"
          else
            echo "Backend health check returned HTTP $HEALTH (may still be deploying)"
          fi
        env:
          BACKEND_URL: ${{ vars.STAGING_BACKEND_URL || 'https://backend-production-7e91d.up.railway.app' }}
        continue-on-error: true

      - name: Check Admin Dashboard
        run: |
          echo "Checking Admin Dashboard..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ADMIN_URL" || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "Admin Dashboard is up (HTTP $STATUS)"
          else
            echo "Admin Dashboard returned HTTP $STATUS"
          fi
        env:
          ADMIN_URL: ${{ vars.STAGING_ADMIN_URL || 'https://csai-admin.haimmaik.workers.dev' }}
        continue-on-error: true

  # ===================================
  # Deployment Summary
  # ===================================
  deploy-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [check-deploy, deploy-cloudflare, verify-deployment]
    if: always() && needs.check-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Generate Summary
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | Railway | Auto-deployed on push |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin Dashboard | Cloudflare Pages | ${{ needs.deploy-cloudflare.result == 'success' && 'Triggered' || 'Auto-deploy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Customer Dashboard | Cloudflare Pages | ${{ needs.deploy-cloudflare.result == 'success' && 'Triggered' || 'Auto-deploy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Widget | Cloudflare Pages | ${{ needs.deploy-cloudflare.result == 'success' && 'Triggered' || 'Auto-deploy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Staging URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://backend-production-7e91d.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin**: https://csai-admin.haimmaik.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Customer**: https://csai-customer.haimmaik.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Widget**: https://csai-widget.haimmaik.workers.dev/demo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
